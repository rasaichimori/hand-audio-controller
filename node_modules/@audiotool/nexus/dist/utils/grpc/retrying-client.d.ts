import { MethodInfoUnary, PartialMessage, ServiceType } from '@bufbuild/protobuf';
import { CallOptions, PromiseClient } from '@connectrpc/connect';
import { ValueNotifier } from '../observable-notifier-value';
import { KeepaliveTransport } from './keepalive-transport';

export type RetryOptions = CallOptions & {
    /** pass a value notifier that will turn to false if something goes wrong, and back to true
     * if things are good.
     */
    callIsOk?: ValueNotifier<boolean>;
    /** log if a retry happens. */
    logIfRetrying?: boolean;
    /** pass `keepalive` to fetch to finish the request even if the page unloads. */
    keepalive?: boolean;
};
/** RetryingClient, like PromiseClient, is a simple client that supports unary and server-streaming
 * methods. Methods will produce a promise for the response message,
 * or an asynchronous iterable of response messages.
 *
 * Unary calls never throw. Instead, they will retry a call if the error fulfills a predicate
 * defined when creating the client, or return an error if not; it's thus safe to
 * not wrap calls in try/catch, and just check if the returned value is an instance of Error.
 *
 * Unary network calls also allow passing in a boolean {@link ValueNotifier}
 * that will be turned to false while a failure occurs that causes the call to retry,
 * and true once the call succeeds again.
 */
export type RetryingClient<T extends ServiceType> = {
    [P in keyof T["methods"]]: T["methods"][P] extends MethodInfoUnary<infer I, infer O> ? (request: PartialMessage<I>, options?: RetryOptions) => Promise<O | Error> : PromiseClient<T>[P];
};
export type RetryingPromiseClientOptions = {
    /**
     * Predicate an error thrown during a call attempt has to fulfill if the call should be retried.
     * Defaults to retrying on `ConnectError` with codes `Code.Unavailable` and `Code.Unknown`.
     */
    retryErrorPredicate?: (error: Error) => boolean;
    /**
     * Default backoff time in case of reconnects. Defaults to 1000.
     */
    backoffMs?: number;
    /**
     * Whether retries should be logged by default, defaults to true. Can be overwritten for each
     * method call.
     */
    logIfRetrying?: boolean;
};
export declare const createRetryingPromiseClient: <S extends ServiceType>(service: S, transport: KeepaliveTransport, options?: RetryingPromiseClientOptions) => RetryingClient<S>;
