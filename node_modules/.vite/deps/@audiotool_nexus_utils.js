import {
  A,
  E,
  N,
  T,
  _,
  p,
  t
} from "./chunk-VNVVDAFV.js";
import "./chunk-NNIHVWYK.js";

// node_modules/@audiotool/nexus/dist/utils.js
var A2 = (e) => {
  throw TypeError(e);
};
var E2 = (e, t2, r) => t2.has(e) || A2("Cannot " + r);
var a = (e, t2, r) => (E2(e, t2, "read from private field"), r ? r.call(e) : t2.get(e));
var y = (e, t2, r) => t2.has(e) ? A2("Cannot add the same private member more than once") : t2 instanceof WeakSet ? t2.add(e) : t2.set(e, r);
var l;
var n;
var H = class {
  constructor(t2) {
    y(this, l, new A());
    y(this, n, /* @__PURE__ */ new Set());
    t2.forEach((r) => a(this, n).add(r));
  }
  getValue() {
    return Array.from(a(this, n));
  }
  replace(t2) {
    a(this, n).clear(), t2.forEach((r) => a(this, n).add(r)), a(this, l).notify(this.getValue());
  }
  add(t2) {
    a(this, n).has(t2) || (a(this, n).add(t2), a(this, l).notify(this.getValue()));
  }
  delete(t2) {
    a(this, n).has(t2) && (a(this, n).delete(t2), a(this, l).notify(this.getValue()));
  }
  has(t2) {
    return a(this, n).has(t2);
  }
  clear() {
    a(this, n).clear(), a(this, l).notify(this.getValue());
  }
  subscribe(t2, r = false) {
    return r && t2(this.getValue()), a(this, l).subscribe(t2);
  }
  terminate() {
    a(this, l).terminate();
  }
};
l = /* @__PURE__ */ new WeakMap(), n = /* @__PURE__ */ new WeakMap();
var F = (e, t2) => Array.from({ length: e }, (r, o) => t2(o));
var C = "https://oauth.audiotool.com/oauth2/auth";
var N2 = "https://oauth.audiotool.com/oauth2/token";
var L = "https://rpc.audiotool.com";
var M = async ({
  clientId: e,
  redirectUrl: t2,
  scope: r
}) => {
  const o = {
    accessToken: `oidc_${e}_oidc_access_token`,
    refreshToken: `oidc_${e}_oidc_refresh_token`,
    expiresAt: `oidc_${e}_oidc_expires_at`,
    codeVerifier: `oidc_${e}_oidc_code_verifier`,
    userName: `oidc_${e}_oidc_user_name`,
    state: `oidc_${e}_oidc_state`
  }, s = () => $(o, e, r, t2), i = new URLSearchParams(window.location.search), d = i.get("error"), g = i.get("error_description");
  if (d != null)
    return I(), v(o), {
      loggedIn: false,
      error: T2(d, g),
      login: s
    };
  const _2 = i.get("code");
  if (_2 != null) {
    const h = i.get("state"), c = localStorage.getItem(o.state);
    if (h == null || c == null || h !== c)
      return {
        loggedIn: false,
        error: T2(
          "Invalid state URL parameter.",
          "Clean the URL of stale query parameters and try again."
        ),
        login: s
      };
    const m = localStorage.getItem(o.codeVerifier);
    if (m == null)
      return {
        loggedIn: false,
        error: T2("Code verifier not found. Restart the auth flow."),
        login: s
      };
    const p2 = await fetch(N2, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({
        client_id: e,
        grant_type: "authorization_code",
        code: _2,
        redirect_uri: t2,
        code_verifier: m,
        token_endpoint_auth_method: "none"
      })
    }), {
      access_token: S,
      refresh_token: f,
      expires_in: w,
      error: V,
      error_description: x
    } = await p2.json();
    if (V)
      return {
        loggedIn: false,
        error: T2(V, x),
        login: s
      };
    localStorage.setItem(o.accessToken, S), localStorage.setItem(o.refreshToken, f), localStorage.setItem(
      o.expiresAt,
      (Date.now() + w * 1e3).toString()
    ), I(), localStorage.removeItem(o.codeVerifier);
  }
  localStorage.removeItem(o.state);
  const k = await P(o, e);
  let u;
  if (typeof k == "string") {
    const h = async () => {
      if (u == null) {
        u = (async () => await P(o, e) ?? new Error("User not logged in."))();
        const m = await u;
        return u = void 0, m;
      }
      return await u;
    };
    let c;
    return {
      loggedIn: true,
      getToken: h,
      getUserName: async () => {
        if (c !== void 0)
          return await c;
        const { promise: m, resolve: p2 } = Promise.withResolvers();
        c = m;
        const S = await h();
        if (S instanceof Error)
          return p2(S), await c;
        const f = await E(
          `${L}/audiotool.auth.v1.AuthService/GetWhoami`,
          {
            method: "POST",
            headers: {
              Authorization: `Bearer ${S}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({})
          }
        );
        if (f instanceof Error)
          return p2(f), await c;
        if (!f.ok)
          return p2(new Error(`Failed to get user info: ${f.statusText}`)), await c;
        const { whoami: w } = await f.json();
        return console.debug("whoami", w), p2((w == null ? void 0 : w.userName) ?? "Unknown User"), await c;
      },
      logout() {
        v(o), I(), window.location.reload();
      }
    };
  }
  return {
    loggedIn: false,
    error: k,
    login: s
  };
};
var v = (e) => {
  localStorage.removeItem(e.accessToken), localStorage.removeItem(e.refreshToken), localStorage.removeItem(e.expiresAt), localStorage.removeItem(e.codeVerifier), localStorage.removeItem(e.userName), localStorage.removeItem(e.state);
};
var I = () => {
  const e = new URL(window.location.href);
  e.searchParams.delete("code"), e.searchParams.delete("scope"), e.searchParams.delete("state"), e.searchParams.delete("error"), e.searchParams.delete("error_description"), window.history.replaceState(
    {},
    document.title,
    e.search ? e.href : e.href.replace("?", "")
  );
};
var $ = async (e, t2, r, o) => {
  const s = O();
  localStorage.setItem(e.codeVerifier, s);
  const i = await b(s), d = crypto.getRandomValues(new Uint8Array(16)).join("");
  localStorage.setItem(e.state, d);
  const g = new URL(C);
  g.search = new URLSearchParams({
    response_type: "code",
    client_id: t2,
    scope: r,
    code_challenge_method: "S256",
    code_challenge: i,
    redirect_uri: o,
    state: d
  }).toString(), window.location.href = g.toString();
};
var T2 = (e, t2) => (t2 = t2 ? `: ${t2}` : "", new Error(`${e}${t2}`));
var O = () => {
  const e = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  return crypto.getRandomValues(new Uint8Array(64)).reduce(
    (r, o) => r + e[o % e.length],
    ""
  );
};
var b = async (e) => {
  const t2 = new TextEncoder().encode(e), r = await crypto.subtle.digest("SHA-256", t2);
  return btoa(String.fromCharCode(...new Uint8Array(r))).replace(/=/g, "").replace(/\+/g, "-").replace(/\//g, "_");
};
var P = async (e, t2) => {
  const r = localStorage.getItem(e.accessToken);
  if (r == null)
    return;
  let o = true;
  {
    const h = localStorage.getItem(e.expiresAt);
    o = h == null ? true : Date.now() >= parseInt(h) - 6e4;
  }
  if (!o)
    return r;
  const s = localStorage.getItem(e.refreshToken);
  if (s == null) {
    v(e);
    return;
  }
  const i = await E(N2, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: new URLSearchParams({
      client_id: t2,
      grant_type: "refresh_token",
      refresh_token: s
    })
  });
  if (i instanceof Error)
    return new Error(`Error during refresh token request: ${i.name}`, {
      cause: i.message
    });
  const { error: d, error_description: g, access_token: _2, refresh_token: k, expires_in: u } = await i.json();
  return d ? T2(d, g) : (localStorage.setItem(e.accessToken, _2), localStorage.setItem(e.refreshToken, k), localStorage.setItem(
    e.expiresAt,
    (Date.now() + u * 1e3).toString()
  ), _2);
};
export {
  T as AsyncLock,
  N as HashMap,
  p as MapValueNotifier,
  A as Notifier,
  H as SetNotifier,
  _ as ValueNotifier,
  F as createArrayTyped,
  M as getLoginStatus,
  E as neverThrowingFetch,
  t as throw_
};
//# sourceMappingURL=@audiotool_nexus_utils.js.map
